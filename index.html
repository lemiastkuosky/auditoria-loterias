<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auditoria PRO v6.5 | Sistema de Extrações</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { 
            --bg: #0d0d0d; 
            --surface: #1a1a1a; 
            --border: #2a2a2a; 
            --accent: #d1d1d1; 
            --text: #ffffff; 
            --dim: #888; 
            --warn: #ff9800; 
            --success: #4caf50; 
            --danger: #f44336;
        }

        * { box-sizing: border-box; }

        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            margin: 0; 
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .container { 
            max-width: 1300px; 
            margin: 0 auto; 
            padding: 25px; 
            flex: 1;
            width: 100%;
        }
        
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 1px solid var(--border); 
            padding-bottom: 15px; 
            margin-bottom: 25px; 
        }

        .header h1 { font-size: 16px; letter-spacing: 2px; text-transform: uppercase; color: var(--accent); margin: 0; }

        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); 
            gap: 15px; 
            margin-bottom: 25px; 
        }

        .stat-card { 
            background: var(--surface); 
            border: 1px solid var(--border); 
            padding: 20px; 
            border-radius: 4px; 
        }

        .stat-card span { display: block; font-size: 9px; color: var(--dim); text-transform: uppercase; margin-bottom: 8px; font-weight: 700; }
        .stat-card .value { font-family: 'JetBrains Mono', monospace; font-size: 24px; font-weight: 500; }

        .chart-box { 
            background: var(--surface); 
            border: 1px solid var(--border); 
            padding: 20px; 
            height: 280px; 
            margin-bottom: 25px; 
            border-radius: 4px;
        }

        .filters { 
            background: var(--surface); 
            border: 1px solid var(--border); 
            padding: 15px; 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
            gap: 15px; 
            margin-bottom: 25px; 
            align-items: flex-end;
        }

        .filter-group { display: flex; flex-direction: column; gap: 8px; }
        .filter-group label { font-size: 10px; color: var(--dim); text-transform: uppercase; font-weight: 700; }

        select, input { background: #000; border: 1px solid var(--border); color: #fff; padding: 10px; font-size: 12px; border-radius: 4px; outline: none; }

        .table-wrap { 
            background: var(--surface); 
            border: 1px solid var(--border); 
            border-radius: 4px; 
            overflow-x: auto; 
            margin-bottom: 50px;
        }

        table { width: 100%; border-collapse: collapse; text-align: left; }
        th { background: #222; padding: 15px; font-size: 10px; color: var(--dim); text-transform: uppercase; border-bottom: 1px solid var(--border); }
        td { padding: 15px; border-bottom: 1px solid var(--border); font-size: 13px; }
        
        .row-suspect { background: rgba(255, 152, 0, 0.05); border-left: 4px solid var(--warn); }
        .warn-badge { background: var(--warn); color: #000; padding: 2px 6px; border-radius: 2px; font-size: 9px; font-weight: 800; }
        .price-up { color: var(--success); font-weight: 700; }

        /* Rodapé com Status em Texto */
        footer { 
            background: #050505; 
            padding: 12px 30px; 
            border-top: 1px solid var(--border); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            position: fixed; 
            bottom: 0; 
            width: 100%;
            z-index: 100;
        }

        .status-group { display: flex; gap: 25px; }
        .status-item { display: flex; align-items: center; gap: 8px; font-size: 10px; font-weight: 600; color: var(--dim); }
        
        .led { width: 8px; height: 8px; border-radius: 50%; background: #333; }
        .led.active { background: var(--success); box-shadow: 0 0 8px var(--success); }
        .led.error { background: var(--danger); box-shadow: 0 0 8px var(--danger); }

        .status-label { color: var(--accent); font-weight: 700; }
        .credits { font-size: 11px; font-weight: 700; color: var(--accent); letter-spacing: 1px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>Auditoria PRO</h1>
        <div id="clock" style="font-family: 'JetBrains Mono'; color: var(--dim); font-size: 12px;">--/--/-- 00:00:00</div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <span>Volume Total Auditado</span>
            <div class="value" id="vTotal" style="color:var(--success)">R$ 0,00</div>
        </div>
        <div class="stat-card">
            <span>Alertas Suspeitos</span>
            <div class="value" id="vAlertas" style="color:var(--warn)">0</div>
        </div>
        <div class="stat-card">
            <span>Ticket Médio</span>
            <div class="value" id="vMedia">R$ 0,00</div>
        </div>
        <div class="stat-card">
            <span>Status do Robô</span>
            <div class="value" id="robotStatus" style="font-size: 14px; color: var(--accent);">INICIALIZANDO...</div>
        </div>
    </div>

    <div class="chart-box">
        <canvas id="heatmapChart"></canvas>
    </div>

    <div class="filters">
        <div class="filter-group">
            <label>Data</label>
            <input type="date" id="fData" onchange="processarDados()">
        </div>
        <div class="filter-group">
            <label>Extração</label>
            <select id="fLoteria" onchange="processarDados()">
                <option value="">TODAS AS LOTERIAS</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Análise de Risco</label>
            <select id="fSuspeito" onchange="processarDados()">
                <option value="todos">GERAL</option>
                <option value="sim">SUSPEITOS ⚠️</option>
            </select>
        </div>
        <button onclick="carregarBanco()" style="background:#333; color:#fff; border:none; padding:10px; border-radius:4px; cursor:pointer; font-weight:700; font-size:10px;">ATUALIZAR DADOS</button>
    </div>

    <div class="table-wrap">
        <table>
            <thead>
                <tr>
                    <th>Horário</th>
                    <th>Extração</th>
                    <th>Tipo</th>
                    <th>Identificação</th>
                    <th>Valor</th>
                    <th>Auditoria</th>
                </tr>
            </thead>
            <tbody id="corpoTabela"></tbody>
        </table>
    </div>
</div>

<footer>
    <div class="status-group">
        <div class="status-item">
            <div id="lGit" class="led"></div> GITHUB: <span id="tGit" class="status-label">OFFLINE</span>
        </div>
        <div class="status-item">
            <div id="lSvr" class="led"></div> API SERVIDOR: <span id="tSvr" class="status-label">AGUARDANDO...</span>
        </div>
    </div>
    
    <div class="credits">CRIADO POR LE | v6.5</div>
</footer>

<script>
    let bancoTotal = [];
    let chartInstancia = null;

    async function iniciar() {
        document.getElementById('fData').value = new Date().toISOString().split('T')[0];
        setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleString('pt-BR'); }, 1000);
        await carregarBanco();
        setInterval(carregarBanco, 300000); // 5 min
    }

    async function carregarBanco() {
        const lGit = document.getElementById('lGit');
        const tGit = document.getElementById('tGit');
        const robotStatus = document.getElementById('robotStatus');

        try {
            const response = await fetch('dados_loterias.json?v=' + Date.now());
            if(!response.ok) throw new Error();
            
            bancoTotal = await response.json();
            
            // Sucesso no GitHub
            lGit.className = 'led active';
            tGit.innerText = 'ONLINE';
            robotStatus.innerText = 'ATIVO (15m)';

            povoarFiltroLoterias();
            validarStatusServidor();
            processarDados();
        } catch (e) {
            lGit.className = 'led error';
            tGit.innerText = 'FALHA DE LINK';
            robotStatus.innerText = 'ERRO NO ARQUIVO';
        }
    }

    function validarStatusServidor() {
        const lSvr = document.getElementById('lSvr');
        const tSvr = document.getElementById('tSvr');

        if(!bancoTotal.length) {
            tSvr.innerText = 'SEM DADOS';
            return;
        }

        const ultimaData = new Date(bancoTotal[bancoTotal.length - 1].timestamp_local);
        const diffMinutos = (new Date() - ultimaData) / (1000 * 60);

        if(diffMinutos < 45) {
            lSvr.className = 'led active';
            tSvr.innerText = 'SINCRONIZADO';
        } else {
            lSvr.className = 'led';
            tSvr.innerText = 'ATRASADO';
        }
    }

    function povoarFiltroLoterias() {
        const select = document.getElementById('fLoteria');
        const loteriasUnicas = [...new Set(bancoTotal.map(i => i.loteria))].sort();
        if(select.options.length <= 1) {
            loteriasUnicas.forEach(l => select.add(new Option(l, l)));
        }
    }

    function processarDados() {
        const dataF = document.getElementById('fData').value.split('-').reverse().join('/');
        const lotF = document.getElementById('fLoteria').value;
        const suspF = document.getElementById('fSuspeito').value;

        const filtrados = bancoTotal.filter(item => {
            const matchData = !document.getElementById('fData').value || item.dia === dataF;
            const matchLot = !lotF || item.loteria === lotF;
            const matchSusp = suspF === 'todos' || (suspF === 'sim' && item.suspeito);
            return matchData && matchLot && matchSusp;
        });

        renderizar(filtrados);
    }

    function renderizar(dados) {
        const corpo = document.getElementById('corpoTabela');
        let somaValores = 0;
        let countSuspeitos = 0;
        const intensidadeHoras = Array(24).fill(0);

        corpo.innerHTML = dados.slice().reverse().map(i => {
            const vLimpo = parseFloat(i.valor.replace(/[^\d,]/g, '').replace(',', '.'));
            somaValores += isNaN(vLimpo) ? 0 : vLimpo;
            if(i.suspeito) countSuspeitos++;
            const hora = parseInt(i.horario_extracao.split(':')[0]);
            intensidadeHoras[hora] += isNaN(vLimpo) ? 0 : vLimpo;

            return `
                <tr class="${i.suspeito ? 'row-suspect' : ''}">
                    <td class="mono">${i.horario_extracao}</td>
                    <td><strong>${i.loteria}</strong></td>
                    <td><span class="tag">${i.premio_tipo || 'Extração'}</span></td>
                    <td style="color:var(--dim)">${i.ganhador.substring(0,12)}...</td>
                    <td class="price-up mono">${i.valor}</td>
                    <td>${i.suspeito ? '<span class="warn-badge">ALERTA</span>' : '✅ OK'}</td>
                </tr>
            `;
        }).join('') || '<tr><td colspan="6" style="text-align:center; padding:50px; color:var(--dim);">AGUARDANDO SORTEIOS...</td></tr>';

        document.getElementById('vTotal').innerText = somaValores.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
        document.getElementById('vAlertas').innerText = countSuspeitos;
        document.getElementById('vMedia').innerText = dados.length ? (somaValores/dados.length).toLocaleString('pt-BR', {style:'currency', currency:'BRL'}) : 'R$ 0,00';
        
        gerarGrafico(intensidadeHoras);
    }

    function gerarGrafico(dadosH) {
        const ctx = document.getElementById('heatmapChart').getContext('2d');
        if(chartInstancia) chartInstancia.destroy();
        chartInstancia = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Array.from({length: 24}, (_, i) => i + 'h'),
                datasets: [{
                    data: dadosH,
                    backgroundColor: 'rgba(76, 175, 80, 0.4)',
                    borderColor: '#4caf50',
                    borderWidth: 1,
                    borderRadius: 3
                }]
            },
            options: {
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, grid: { color: '#222' }, ticks: { color: '#666', font: { size: 10 } } },
                    x: { grid: { display: false }, ticks: { color: '#666', font: { size: 10 } } }
                }
            }
        });
    }

    iniciar();
</script>

</body>
</html>