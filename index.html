<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auditoria PRO</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { 
            --bg: #0d0d0d; 
            --surface: #1a1a1a; 
            --border: #2a2a2a; 
            --accent: #d1d1d1; 
            --text: #ffffff; 
            --dim: #888; 
            --warn: #ff9800; 
            --success: #4caf50; 
        }

        * { box-sizing: border-box; }

        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            margin: 0; 
            padding: 0; 
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .container { 
            max-width: 1300px; 
            margin: 0 auto; 
            padding: 25px; 
            flex: 1;
            width: 100%;
        }
        
        /* Cabeçalho Profissional */
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 1px solid var(--border); 
            padding-bottom: 15px; 
            margin-bottom: 25px; 
        }

        .header h1 { 
            font-size: 16px; 
            letter-spacing: 2px; 
            text-transform: uppercase; 
            color: var(--accent); 
            margin: 0; 
        }

        /* Dashboard de Métricas */
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); 
            gap: 15px; 
            margin-bottom: 25px; 
        }

        .stat-card { 
            background: var(--surface); 
            border: 1px solid var(--border); 
            padding: 20px; 
            border-radius: 4px; 
        }

        .stat-card span { 
            display: block; 
            font-size: 9px; 
            color: var(--dim); 
            text-transform: uppercase; 
            margin-bottom: 8px; 
            font-weight: 700; 
        }

        .stat-card .value { 
            font-family: 'JetBrains Mono', monospace; 
            font-size: 24px; 
            font-weight: 500;
        }

        /* Gráfico de Intensidade */
        .chart-box { 
            background: var(--surface); 
            border: 1px solid var(--border); 
            padding: 20px; 
            height: 280px; 
            margin-bottom: 25px; 
            border-radius: 4px;
        }

        /* Barra de Filtros Avançados */
        .filters { 
            background: var(--surface); 
            border: 1px solid var(--border); 
            padding: 15px; 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
            gap: 15px; 
            margin-bottom: 25px; 
            align-items: flex-end;
        }

        .filter-group { display: flex; flex-direction: column; gap: 8px; }
        .filter-group label { font-size: 10px; color: var(--dim); text-transform: uppercase; font-weight: 700; }

        select, input { 
            background: #000; 
            border: 1px solid var(--border); 
            color: #fff; 
            padding: 10px; 
            font-size: 12px; 
            border-radius: 4px; 
            outline: none;
        }

        .btn-refresh {
            background: #2a2a2a;
            color: #fff;
            border: 1px solid var(--border);
            padding: 10px;
            cursor: pointer;
            font-weight: 700;
            font-size: 10px;
            text-transform: uppercase;
            transition: 0.3s;
        }

        .btn-refresh:hover { background: #333; }

        /* Tabela de Auditoria */
        .table-wrap { 
            background: var(--surface); 
            border: 1px solid var(--border); 
            border-radius: 4px; 
            overflow-x: auto; 
            margin-bottom: 50px;
        }

        table { width: 100%; border-collapse: collapse; text-align: left; }
        th { background: #222; padding: 15px; font-size: 10px; color: var(--dim); text-transform: uppercase; border-bottom: 1px solid var(--border); }
        td { padding: 15px; border-bottom: 1px solid var(--border); font-size: 13px; }
        
        .mono { font-family: 'JetBrains Mono', monospace; }
        .row-suspect { background: rgba(255, 152, 0, 0.05); border-left: 4px solid var(--warn); }
        .warn-badge { background: var(--warn); color: #000; padding: 2px 6px; border-radius: 2px; font-size: 9px; font-weight: 800; }
        .price-up { color: var(--success); font-weight: 700; }

        /* Rodapé de Status Estilizado */
        footer { 
            background: #050505; 
            padding: 12px 30px; 
            border-top: 1px solid var(--border); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            position: fixed; 
            bottom: 0; 
            width: 100%;
            z-index: 100;
        }

        .status-group { display: flex; gap: 20px; }
        .status-item { display: flex; align-items: center; gap: 8px; font-size: 10px; font-weight: 600; color: var(--dim); }
        
        .led { 
            width: 8px; 
            height: 8px; 
            border-radius: 50%; 
            background: #333; 
            transition: 0.5s;
        }
        .led.active { background: var(--success); box-shadow: 0 0 8px var(--success); }

        .credits { font-size: 11px; font-weight: 700; color: var(--accent); letter-spacing: 1px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>Auditoria Estratégica v6.0</h1>
        <div id="clock" style="font-family: 'JetBrains Mono'; color: var(--dim); font-size: 12px;">--/--/-- 00:00:00</div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <span>Total Premiado (Filtro)</span>
            <div class="value" id="vTotal" style="color:var(--success)">R$ 0,00</div>
        </div>
        <div class="stat-card">
            <span>Alertas Suspeitos</span>
            <div class="value" id="vAlertas" style="color:var(--warn)">0</div>
        </div>
        <div class="stat-card">
            <span>Ticket Médio Prêmios</span>
            <div class="value" id="vMedia">R$ 0,00</div>
        </div>
        <div class="stat-card">
            <span>Intervalo de Captura</span>
            <div class="value" style="font-size: 14px; color: var(--accent);">15 EM 15 MINUTOS</div>
        </div>
    </div>

    <div class="chart-box">
        <canvas id="heatmapChart"></canvas>
    </div>

    <div class="filters">
        <div class="filter-group">
            <label>Data</label>
            <input type="date" id="fData" onchange="processarDados()">
        </div>
        <div class="filter-group">
            <label>Loteria / Extração</label>
            <select id="fLoteria" onchange="processarDados()">
                <option value="">TODAS AS LOTERIAS</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Análise de Risco</label>
            <select id="fSuspeito" onchange="processarDados()">
                <option value="todos">TODOS OS REGISTROS</option>
                <option value="sim">APENAS SUSPEITOS ⚠️</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Busca Rápida</label>
            <input type="text" id="fBusca" placeholder="Pesquisar..." oninput="processarDados()">
        </div>
        <button class="btn-refresh" onclick="carregarBanco()">Atualizar Agora</button>
    </div>

    <div class="table-wrap">
        <table>
            <thead>
                <tr>
                    <th>Horário</th>
                    <th>Extração / Loteria</th>
                    <th>Tipo de Prêmio</th>
                    <th>Identificação</th>
                    <th>Valor do Prêmio</th>
                    <th>Auditoria</th>
                </tr>
            </thead>
            <tbody id="corpoTabela">
                </tbody>
        </table>
    </div>
</div>

<footer>
    <div class="status-group">
        <div class="status-item"><div id="lGit" class="led active"></div> GITHUB PAGES</div>
        <div class="status-item"><div id="lSvr" class="led"></div> SINCRONIZAÇÃO API</div>
        <div id="lastSync" style="font-family: 'JetBrains Mono'; margin-left: 10px;">SYNC: --:--</div>
    </div>
    
    <div class="credits">CRIADO POR LE | v6.0</div>
</footer>

<script>
    let bancoTotal = [];
    let chartInstancia = null;

    // Inicialização
    async function iniciar() {
        document.getElementById('fData').value = new Date().toISOString().split('T')[0];
        // Relógio
        setInterval(() => {
            document.getElementById('clock').innerText = new Date().toLocaleString('pt-BR');
        }, 1000);

        await carregarBanco();
        
        // ATUALIZAÇÃO AUTOMÁTICA EM 5 MINUTOS
        setInterval(carregarBanco, 300000);
    }

    async function carregarBanco() {
        try {
            const response = await fetch('dados_loterias.json?v=' + Date.now());
            bancoTotal = await response.json();
            
            povoarFiltroLoterias();
            validarStatusServidor();
            processarDados();
            
            document.getElementById('lastSync').innerText = "SYNC: " + new Date().toLocaleTimeString();
        } catch (e) {
            console.error("Erro ao carregar dados_loterias.json. Verifique se o robô já rodou.");
        }
    }

    function povoarFiltroLoterias() {
        const select = document.getElementById('fLoteria');
        const loteriasUnicas = [...new Set(bancoTotal.map(i => i.loteria))].sort();
        
        if(select.options.length <= 1) {
            loteriasUnicas.forEach(l => {
                const opt = new Option(l, l);
                select.add(opt);
            });
        }
    }

    function validarStatusServidor() {
        if(!bancoTotal.length) return;
        const ultimaData = new Date(bancoTotal[bancoTotal.length - 1].timestamp_local);
        const agora = new Date();
        const diffMinutos = (agora - ultimaData) / (1000 * 60);

        // Se o último registro foi há menos de 45 minutos, LED verde
        const led = document.getElementById('lSvr');
        if(diffMinutos < 45) {
            led.classList.add('active');
        } else {
            led.classList.remove('active');
        }
    }

    function processarDados() {
        const dataF = document.getElementById('fData').value.split('-').reverse().join('/');
        const lotF = document.getElementById('fLoteria').value;
        const suspF = document.getElementById('fSuspeito').value;
        const buscaF = document.getElementById('fBusca').value.toLowerCase();

        const filtrados = bancoTotal.filter(item => {
            const matchData = !document.getElementById('fData').value || item.dia === dataF;
            const matchLot = !lotF || item.loteria === lotF;
            const matchSusp = suspF === 'todos' || (suspF === 'sim' && item.suspeito);
            const matchBusca = item.ganhador.toLowerCase().includes(buscaF) || item.valor.includes(buscaF);

            return matchData && matchLot && matchSusp && matchBusca;
        });

        renderizar(filtrados);
    }

    function renderizar(dados) {
        const corpo = document.getElementById('corpoTabela');
        let somaValores = 0;
        let countSuspeitos = 0;
        const intensidadeHoras = Array(24).fill(0);

        corpo.innerHTML = dados.slice().reverse().map(i => {
            // Cálculo financeiro
            const vLimpo = parseFloat(i.valor.replace(/[^\d,]/g, '').replace(',', '.'));
            somaValores += isNaN(vLimpo) ? 0 : vLimpo;
            
            if(i.suspeito) countSuspeitos++;

            // Intensidade por hora para o gráfico
            const hora = parseInt(i.horario_extracao.split(':')[0]);
            intensidadeHoras[hora] += isNaN(vLimpo) ? 0 : vLimpo;

            return `
                <tr class="${i.suspeito ? 'row-suspect' : ''}">
                    <td class="mono">${i.horario_extracao}</td>
                    <td><strong>${i.loteria}</strong></td>
                    <td><span class="tag">${i.premio_tipo || 'Extração'}</span></td>
                    <td style="color: var(--dim)">${i.ganhador.substring(0,10)}***</td>
                    <td class="price-up mono">${i.valor}</td>
                    <td>${i.suspeito ? '<span class="warn-badge">ALERTA</span>' : '✅ CONFERIDO'}</td>
                </tr>
            `;
        }).join('') || '<tr><td colspan="6" style="text-align:center; padding:50px; color:var(--dim);">SEM REGISTROS ENCONTRADOS</td></tr>';

        // Atualiza Cards
        document.getElementById('vTotal').innerText = somaValores.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
        document.getElementById('vAlertas').innerText = countSuspeitos;
        document.getElementById('vMedia').innerText = dados.length ? (somaValores/dados.length).toLocaleString('pt-BR', {style:'currency', currency:'BRL'}) : 'R$ 0,00';
        
        gerarGraficoIntensidade(intensidadeHoras);
    }

    function gerarGraficoIntensidade(dadosH) {
        const ctx = document.getElementById('heatmapChart').getContext('2d');
        
        if(chartInstancia) chartInstancia.destroy();

        chartInstancia = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Array.from({length: 24}, (_, i) => i + 'h'),
                datasets: [{
                    label: 'Volume por Hora (R$)',
                    data: dadosH,
                    backgroundColor: dadosH.map(v => v > 0 ? 'rgba(76, 175, 80, 0.4)' : 'rgba(45, 45, 45, 0.2)'),
                    borderColor: '#4caf50',
                    borderWidth: 1,
                    borderRadius: 3
                }]
            },
            options: {
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, grid: { color: '#222' }, ticks: { color: '#666', font: { size: 10 } } },
                    x: { grid: { display: false }, ticks: { color: '#666', font: { size: 10 } } }
                }
            }
        });
    }

    // Start
    iniciar();
</script>

</body>
</html>