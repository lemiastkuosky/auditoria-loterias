<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auditoria PRO</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { 
            --bg: #0d0d0d; 
            --surface: #1a1a1a; 
            --border: #2a2a2a; 
            --accent: #d1d1d1; 
            --text: #ffffff; 
            --dim: #888; 
            --warn: #ff9800; 
            --success: #4caf50; 
            --danger: #f44336;
        }

        * { box-sizing: border-box; }

        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            margin: 0; 
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .container { 
            max-width: 1300px; 
            margin: 0 auto; 
            padding: 20px; 
            flex: 1;
            width: 100%;
            padding-bottom: 90px; /* Espaço para não esconder conteúdo atrás do rodapé */
        }
        
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 1px solid var(--border); 
            padding-bottom: 15px; 
            margin-bottom: 25px; 
        }

        .header h1 { font-size: 16px; letter-spacing: 2px; text-transform: uppercase; color: var(--accent); margin: 0; }
        
        @media (max-width: 600px) {
            .header { flex-direction: column; gap: 10px; align-items: flex-start; }
            .header h1 { font-size: 14px; }
        }

        /* CARDS PRINCIPAIS */
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 15px; 
            margin-bottom: 15px; /* Reduzi a margem para colar no painel financeiro */
        }

        .stat-card { 
            background: var(--surface); 
            border: 1px solid var(--border); 
            padding: 20px; 
            border-radius: 4px; 
        }

        .stat-card span { display: block; font-size: 9px; color: var(--dim); text-transform: uppercase; margin-bottom: 8px; font-weight: 700; }
        .stat-card .value { font-family: 'JetBrains Mono', monospace; font-size: 20px; font-weight: 500; }

        /* --- NOVO PAINEL FINANCEIRO (MÊS/SEMANA) --- */
        .summary-bar {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 25px;
            background: #111;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #333;
        }

        .sum-item { text-align: center; border-right: 1px solid #333; }
        .sum-item:last-child { border-right: none; }
        .sum-item h3 { font-size: 10px; color: #888; margin: 0 0 5px 0; letter-spacing: 1px; }
        .sum-item p { font-size: 18px; color: #fff; margin: 0; font-family: 'JetBrains Mono'; font-weight: 700; }
        
        /* Destaque para o mês */
        .sum-item.highlight p { color: var(--success); text-shadow: 0 0 10px rgba(76, 175, 80, 0.2); }

        @media (max-width: 600px) {
            .summary-bar { gap: 10px; padding: 10px; grid-template-columns: 1fr 1fr 1fr; }
            .sum-item p { font-size: 13px; }
            .sum-item h3 { font-size: 9px; }
        }

        /* GRÁFICO E FILTROS */
        .chart-box { 
            background: var(--surface); 
            border: 1px solid var(--border); 
            padding: 20px; 
            height: 280px; 
            margin-bottom: 25px; 
            border-radius: 4px;
        }

        .filters { 
            background: var(--surface); 
            border: 1px solid var(--border); 
            padding: 15px; 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
            gap: 15px; 
            margin-bottom: 25px; 
            align-items: flex-end;
        }

        .filter-group { display: flex; flex-direction: column; gap: 8px; }
        .filter-group label { font-size: 10px; color: var(--dim); text-transform: uppercase; font-weight: 700; }

        select, input { background: #000; border: 1px solid var(--border); color: #fff; padding: 10px; font-size: 12px; border-radius: 4px; outline: none; width: 100%; }
        
        button.btn-update {
            background:#333; color:#fff; border:none; padding:10px; border-radius:4px; cursor:pointer; font-weight:700; font-size:10px; width: 100%; transition: 0.2s;
        }
        button.btn-update:hover { background: var(--accent); color: #000; }

        /* TABELA */
        .table-wrap { 
            background: var(--surface); 
            border: 1px solid var(--border); 
            border-radius: 4px; 
            overflow-x: auto; 
            margin-bottom: 20px;
        }

        table { width: 100%; border-collapse: collapse; text-align: left; min-width: 600px; }
        th { background: #222; padding: 15px; font-size: 10px; color: var(--dim); text-transform: uppercase; border-bottom: 1px solid var(--border); white-space: nowrap; }
        td { padding: 15px; border-bottom: 1px solid var(--border); font-size: 13px; white-space: nowrap; }
        
        .row-suspect { background: rgba(255, 152, 0, 0.05); border-left: 4px solid var(--warn); }
        .warn-badge { background: var(--warn); color: #000; padding: 2px 6px; border-radius: 2px; font-size: 9px; font-weight: 800; }
        .price-up { color: var(--success); font-weight: 700; font-family: 'JetBrains Mono', monospace; }
        .tag { background: #333; padding: 2px 6px; border-radius: 3px; font-size: 10px; color: #ccc; }

        /* --- RODAPÉ RESPONSIVO --- */
        footer { 
            background: #050505; 
            padding: 10px 20px; 
            border-top: 1px solid var(--border); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            position: fixed; 
            bottom: 0; 
            left: 0;
            width: 100%;
            z-index: 100;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.5);
        }

        .status-group { display: flex; gap: 25px; align-items: center; }
        .status-item { display: flex; align-items: center; gap: 8px; font-size: 10px; font-weight: 600; color: var(--dim); white-space: nowrap; }
        
        .led { width: 8px; height: 8px; border-radius: 50%; background: #333; flex-shrink: 0; transition: 0.3s; }
        .led.active { background: var(--success); box-shadow: 0 0 8px var(--success); }
        .led.error { background: var(--danger); box-shadow: 0 0 8px var(--danger); }

        .status-label { color: var(--accent); font-weight: 700; }
        .credits { font-size: 10px; font-weight: 700; color: var(--accent); letter-spacing: 1px; white-space: nowrap; }

        /* Modo Celular Específico */
        @media (max-width: 600px) {
            footer {
                flex-direction: column;
                padding: 12px;
                gap: 10px;
            }
            .status-group {
                justify-content: center;
                width: 100%;
                gap: 15px;
            }
            .credits {
                font-size: 9px;
                opacity: 0.5;
            }
            .stats-grid { grid-template-columns: 1fr 1fr; } /* 2 colunas no celular */
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>Dashboard Lets 3D | Auditoria v6.7</h1>
        <div id="clock" style="font-family: 'JetBrains Mono'; color: var(--dim); font-size: 12px;">--/--/-- 00:00:00</div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <span>Volume Auditado (Filtro)</span>
            <div class="value" id="vTotal" style="color:var(--success)">R$ 0,00</div>
        </div>
        <div class="stat-card">
            <span>Alertas de Risco</span>
            <div class="value" id="vAlertas" style="color:var(--warn)">0</div>
        </div>
        <div class="stat-card">
            <span>Ticket Médio</span>
            <div class="value" id="vMedia">R$ 0,00</div>
        </div>
        <div class="stat-card">
            <span>Status do Robô</span>
            <div class="value" id="robotStatus" style="font-size: 12px; color: var(--accent); line-height: 24px;">INICIALIZANDO...</div>
        </div>
    </div>

    <div class="summary-bar">
        <div class="sum-item">
            <h3>HOJE</h3>
            <p id="resHoje">R$ 0,00</p>
        </div>
        <div class="sum-item">
            <h3>ÚLTIMOS 7 DIAS</h3>
            <p id="resSemana">R$ 0,00</p>
        </div>
        <div class="sum-item highlight">
            <h3>ACUMULADO MÊS</h3>
            <p id="resMes">R$ 0,00</p>
        </div>
    </div>

    <div class="chart-box">
        <canvas id="heatmapChart"></canvas>
    </div>

    <div class="filters">
        <div class="filter-group">
            <label>Data</label>
            <input type="date" id="fData" onchange="processarDados()">
        </div>
        <div class="filter-group">
            <label>Extração</label>
            <select id="fLoteria" onchange="processarDados()">
                <option value="">TODAS AS LOTERIAS</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Auditoria</label>
            <select id="fSuspeito" onchange="processarDados()">
                <option value="todos">GERAL</option>
                <option value="sim">APENAS SUSPEITOS ⚠️</option>
            </select>
        </div>
        <div class="filter-group">
            <label>&nbsp;</label>
            <button class="btn-update" onclick="carregarBanco()">ATUALIZAR AGORA</button>
        </div>
    </div>

    <div class="table-wrap">
        <table>
            <thead>
                <tr>
                    <th>Horário</th>
                    <th>Extração</th>
                    <th>Modalidade</th>
                    <th>Ganhador</th>
                    <th>Valor</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="corpoTabela"></tbody>
        </table>
    </div>
</div>

<footer>
    <div class="status-group">
        <div class="status-item">
            <div id="lGit" class="led"></div> GITHUB: <span id="tGit" class="status-label">OFFLINE</span>
        </div>
        <div class="status-item">
            <div id="lSvr" class="led"></div> API SERVIDOR: <span id="tSvr" class="status-label">AGUARDANDO...</span>
        </div>
    </div>
    
    <div class="credits">CRIADO POR LE | v6.7</div>
</footer>

<script>
    let bancoTotal = [];
    let chartInstancia = null;

    // Inicia o sistema
    async function iniciar() {
        // Define data de hoje no filtro
        document.getElementById('fData').value = new Date().toISOString().split('T')[0];
        
        // Relógio
        setInterval(() => { 
            document.getElementById('clock').innerText = new Date().toLocaleString('pt-BR'); 
        }, 1000);

        // Carrega dados iniciais
        await carregarBanco();
        
        // Auto-refresh a cada 5 minutos
        setInterval(carregarBanco, 300000); 
    }

    async function carregarBanco() {
        const lGit = document.getElementById('lGit');
        const tGit = document.getElementById('tGit');
        const robotStatus = document.getElementById('robotStatus');

        try {
            // O parâmetro '?v=' evita cache
            const response = await fetch('dados_loterias.json?v=' + Date.now());
            
            if(!response.ok) throw new Error("Arquivo não encontrado");
            
            const texto = await response.text();
            if(!texto) {
                bancoTotal = [];
            } else {
                bancoTotal = JSON.parse(texto);
            }
            
            // Sucesso na leitura do arquivo
            lGit.className = 'led active';
            tGit.innerText = 'ONLINE';
            robotStatus.innerText = 'ATIVO (15m)';

            povoarFiltroLoterias();
            validarStatusServidor();
            processarDados();

        } catch (e) {
            console.error(e);
            lGit.className = 'led error';
            tGit.innerText = 'FALHA DE LEITURA';
            robotStatus.innerText = 'ERRO NO ARQUIVO';
        }
    }

    function validarStatusServidor() {
        const lSvr = document.getElementById('lSvr');
        const tSvr = document.getElementById('tSvr');

        if(!bancoTotal.length) {
            lSvr.className = 'led'; // Cinza
            tSvr.innerText = 'AGUARDANDO DADOS...';
            return;
        }

        // Verifica se o último registro tem menos de 60 minutos
        const ultimoRegistro = bancoTotal[bancoTotal.length - 1];
        const dataUltimo = new Date(ultimoRegistro.timestamp_local);
        const agora = new Date();
        const diffMinutos = (agora - dataUltimo) / (1000 * 60);

        if(diffMinutos < 60) {
            lSvr.className = 'led active';
            tSvr.innerText = 'SINCRONIZADO';
        } else {
            lSvr.className = 'led';
            tSvr.innerText = 'ÚLTIMO: ' + ultimoRegistro.horario_extracao;
        }
    }

    function povoarFiltroLoterias() {
        const select = document.getElementById('fLoteria');
        const loteriasUnicas = [...new Set(bancoTotal.map(i => i.loteria))].sort();
        
        if(select.options.length <= 1) {
            loteriasUnicas.forEach(l => select.add(new Option(l, l)));
        }
    }

    function processarDados() {
        const dataF = document.getElementById('fData').value.split('-').reverse().join('/');
        const lotF = document.getElementById('fLoteria').value;
        const suspF = document.getElementById('fSuspeito').value;

        // 1. FILTRAGEM PARA A TABELA (Respeita data e loteria)
        const filtrados = bancoTotal.filter(item => {
            const matchData = !document.getElementById('fData').value || item.dia === dataF;
            const matchLot = !lotF || item.loteria === lotF;
            const matchSusp = suspF === 'todos' || (suspF === 'sim' && item.suspeito);
            return matchData && matchLot && matchSusp;
        });

        renderizar(filtrados);

        // 2. CÁLCULO FINANCEIRO (Respeita só a loteria, ignora a data para somar o mês)
        calcularResumoFinanceiro(lotF);
    }

    function calcularResumoFinanceiro(loteriaSelecionada) {
        const hoje = new Date();
        const dataHojeStr = hoje.toLocaleDateString('pt-BR'); // dd/mm/aaaa
        const mesAtual = hoje.getMonth();
        const anoAtual = hoje.getFullYear();

        let sHoje = 0;
        let sSemana = 0;
        let sMes = 0;

        // Se tem loteria filtrada, usa só ela. Se não, usa o banco todo.
        const baseCalculo = loteriaSelecionada ? 
            bancoTotal.filter(i => i.loteria === loteriaSelecionada) : 
            bancoTotal;

        baseCalculo.forEach(item => {
            // Limpeza do valor monetário
            const valor = parseFloat(item.valor.replace('R$', '').replace('.', '').replace(',', '.').trim()) || 0;
            
            // Converte string dd/mm/aaaa para Date
            const partes = item.dia.split('/');
            const dataItem = new Date(partes[2], partes[1] - 1, partes[0]);
            
            // Soma Hoje
            if(item.dia === dataHojeStr) sHoje += valor;

            // Soma Mês Atual
            if(dataItem.getMonth() === mesAtual && dataItem.getFullYear() === anoAtual) sMes += valor;

            // Soma Últimos 7 dias
            const diffTempo = hoje - dataItem;
            const diffDias = diffTempo / (1000 * 60 * 60 * 24);
            if(diffDias >= 0 && diffDias <= 7) sSemana += valor;
        });

        // Atualiza os valores na tela
        const fmt = { style: 'currency', currency: 'BRL' };
        document.getElementById('resHoje').innerText = sHoje.toLocaleString('pt-BR', fmt);
        document.getElementById('resSemana').innerText = sSemana.toLocaleString('pt-BR', fmt);
        document.getElementById('resMes').innerText = sMes.toLocaleString('pt-BR', fmt);
    }

    function renderizar(dados) {
        const corpo = document.getElementById('corpoTabela');
        let somaValores = 0;
        let countSuspeitos = 0;
        const intensidadeHoras = Array(24).fill(0);

        corpo.innerHTML = dados.slice().reverse().map(i => {
            const vLimpo = parseFloat(i.valor.replace('R$', '').replace('.', '').replace(',', '.').trim());
            
            if(!isNaN(vLimpo)) {
                somaValores += vLimpo;
                const hora = parseInt(i.horario_extracao.split(':')[0]);
                if(hora >= 0 && hora < 24) intensidadeHoras[hora] += vLimpo;
            }

            if(i.suspeito) countSuspeitos++;

            return `
                <tr class="${i.suspeito ? 'row-suspect' : ''}">
                    <td class="mono">${i.horario_extracao}</td>
                    <td><strong>${i.loteria}</strong></td>
                    <td><span class="tag">${i.premio_tipo || 'Geral'}</span></td>
                    <td style="color:var(--dim)">${i.ganhador}</td>
                    <td class="price-up">${i.valor}</td>
                    <td>${i.suspeito ? '<span class="warn-badge">ALERTA</span>' : '✅ OK'}</td>
                </tr>
            `;
        }).join('') || '<tr><td colspan="6" style="text-align:center; padding:50px; color:var(--dim);">NENHUM DADO ENCONTRADO NESTA DATA</td></tr>';

        // Atualiza Cards Superiores
        document.getElementById('vTotal').innerText = somaValores.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
        document.getElementById('vAlertas').innerText = countSuspeitos;
        document.getElementById('vMedia').innerText = dados.length ? (somaValores/dados.length).toLocaleString('pt-BR', {style:'currency', currency:'BRL'}) : 'R$ 0,00';
        
        gerarGrafico(intensidadeHoras);
    }

    function gerarGrafico(dadosH) {
        const ctx = document.getElementById('heatmapChart').getContext('2d');
        if(chartInstancia) chartInstancia.destroy();
        
        chartInstancia = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Array.from({length: 24}, (_, i) => i + 'h'),
                datasets: [{
                    label: 'Volume de Prêmios',
                    data: dadosH,
                    backgroundColor: 'rgba(76, 175, 80, 0.5)',
                    borderColor: '#4caf50',
                    borderWidth: 1,
                    borderRadius: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, grid: { color: '#222' }, ticks: { color: '#666', font: { size: 9 } } },
                    x: { grid: { display: false }, ticks: { color: '#666', font: { size: 9 } } }
                }
            }
        });
    }

    iniciar();
</script>

</body>
</html>